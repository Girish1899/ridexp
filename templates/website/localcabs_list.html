{% extends "./index.html" %}
{% load static %}

{% block body_content %}

 <!-- book ride -->
 <div class="book-ride py-120">
    <div class="container">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="booking-form">
                    <div class="book-ride-head">
                        <h4 class="booking-title">Make Your Booking Today</h4>
                    </div>
                    <form action="#">
                        <div class="row">
                            <div class="row">
                                <div class="col-lg-3">
                                    <div class="form-group">
                                        <label>Pick Up Location</label>
                                        <input type="text" class="form-control autocomeple_g" placeholder="Type Location" id="source" name="source">
                                        <i class="far fa-location-dot"></i>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="form-group">
                                        <label>Drop Off Location</label>
                                        <input type="text" class="form-control autocomeple_g" placeholder="Type Location" id="destination" name="destination">
                                        <i class="far fa-location-dot"></i>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="form-group">
                                        <label>Pick Up Date:</label>
                                        <input type="text" class="form-control date-picker" placeholder="MM/DD/YY" id="pickup_date" name="pickup_date">
                                        <div id="dateError" class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="form-group">
                                        <label>Pick Up Time:</label>
                                        <input type="time" class="form-control" id="pickup_time" name="pickup_time">
                                    </div>
                                </div>
                
                                <div class="col-lg-3">
                                    <button class="theme-btn" type="submit" id="save_action">Check Fares<i
                                            class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- book ride end -->



<div class="container-xxl py-5">
    <div class="container">
        <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
            <h1 class="mb-5"><span class="text-primary text-uppercase">Select Cabs</span></h1>
        </div>

        <!-- Cab Items -->
        <div class="row g-4">
            {% for category, prices in pricing_dict.items %}
            <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                <div class="room-item shadow rounded overflow-hidden">
                    <div class="position-relative">
                        {% if prices.ac %}
                            <img class="img-fluid" src="{{ prices.ac.category.image.url }}" alt="{{ category|capfirst }}">
                        {% elif prices.non_ac %}
                            <img class="img-fluid" src="{{ prices.non_ac.category.image.url }}" alt="{{ category|capfirst }}">
                        {% else %}
                            <img class="img-fluid" src="{% static 'path/to/default/image.jpg' %}" alt="No Image Available">
                        {% endif %}

                        <div class="position-relative" style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
                            <!-- Non AC Price Display -->
                            <small class="bg-secondary text-white rounded py-1 px-3" style="background-color: #6c757d; color: white; border-radius: 0.25rem; padding: 0.25rem 0.75rem; margin-right: auto;">
                                NON AC ₹ <span id="price_non_ac_{{ category|slugify }}">Not Available</span>
                            </small>
                            <!-- AC Price Display -->
                            <small class="bg-primary text-white rounded py-1 px-3" style="background-color: #007bff; color: white; border-radius: 0.25rem; padding: 0.25rem 0.75rem; margin-left: auto;">
                                AC ₹ <span id="price_ac_{{ category|slugify }}">Not Available</span>
                            </small>
                        </div>
                    </div>

                    <div class="p-4 mt-2">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="mb-0">{{ category|capfirst }}</h5>
                            <small class="border-end me-3 pe-3">
                                <strong>Seats:</strong>
                                {% if prices.ac %}
                                    {{ prices.ac.category.seats }}
                                {% elif prices.non_ac %}
                                    {{ prices.non_ac.category.seats }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </small>
                            <div class="ps-2">
                                <p style="font-size: 15px;"><strong>Distance (km):</strong> <span id="distance_{{ category|slugify }}">0</span></p>
                                
                            </div>
                        </div>
                        
                        <div class="d-flex mb-3">
                            <!-- <small class="border-end me-3 pe-3">
                                <strong>Seats:</strong>
                                {% if prices.ac %}
                                    {{ prices.ac.category.seats }}
                                {% elif prices.non_ac %}
                                    {{ prices.non_ac.category.seats }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </small> -->
                            <small class="border-end me-3 pe-3">
                                <p><strong>Permit:</strong> ₹<span id="permit_ac_{{ category|slugify }}">0</span></p>
                                <p><strong>Permit Non A/C:</strong> ₹<span id="permit_non_ac_{{ category|slugify }}">0</span></p>
                            </small>
                            <small class="border-end me-3 pe-3">
                                <p><strong>Toll:</strong> ₹<span id="toll_ac_{{ category|slugify }}">0</span></p>
                                <p><strong>Toll Non A/C:</strong> ₹<span id="toll_non_ac_{{ category|slugify }}">0</span></p>
                            </small>
                            <small class="border-end me-3 pe-3">
                                <p><strong>Driver Beta:</strong> ₹<span id="beta_ac_{{ category|slugify }}">0</span></p>
                                <p><strong>Driver Beta Non A/C:</strong> ₹<span id="beta_non_ac_{{ category|slugify }}">0</span></p>
                            </small>
                        </div>

                        <div class="d-flex justify-content-between">
                            <!-- Non A/C Booking Button -->
                            <form action="{% url 'booking_list' %}" method="get" class="d-inline" style="flex: 1; margin-right: 5px;">
                                <input type="hidden" name="source" value="{{ request.GET.location1 }}">
                                <input type="hidden" name="destination" value="{{ request.GET.location2 }}">
                                <input type="hidden" name="pickup_date" value="{{ request.GET.pickup_date }}">
                                <input type="hidden" name="pickup_time" value="{{ request.GET.pickup_time }}">
                                <input type="hidden" name="category" value="{{ prices.non_ac.category.category_name }}">
                                <input type="hidden" name="ridetype" value="{{ request.GET.ridetype }}">
                                <input type="hidden" name="price" id="hidden_price_non_ac_{{ category|slugify }}" value="">
                                <button type="submit" class="btn btn-sm btn-danger w-100 rounded py-2 px-4 button-equal" data-category="{{ category|slugify }}" data-type="non_ac" disabled>
                                    Non A/c Not Available
                                </button>
                            </form>
                        
                            <!-- A/C Booking Button -->
                            <form action="{% url 'booking_list' %}" method="get" class="d-inline" style="flex: 1; margin-left: 5px;">
                                <input type="hidden" name="source" value="{{ request.GET.location1 }}">
                                <input type="hidden" name="destination" value="{{ request.GET.location2 }}">
                                <input type="hidden" name="pickup_date" value="{{ request.GET.pickup_date }}">
                                <input type="hidden" name="pickup_time" value="{{ request.GET.pickup_time }}">
                                <input type="hidden" name="category" value="{{ prices.ac.category.category_name }}">
                                <input type="hidden" name="ridetype" value="{{ request.GET.ridetype }}">
                                <input type="hidden" name="price" id="hidden_price_ac_{{ category|slugify }}" value="">
                                <button type="submit" class="btn btn-sm w-100 rounded py-2 px-4 button-equal" style="background-color: #41C324; border: none;color: white;" data-category="{{ category|slugify }}" data-type="ac" disabled>
                                    A/c Not Available
                                </button>
                            </form>
                        </div>
                        
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
                        
                
<script>
    var ridetype = "local";
    $(document).ready(function() {
    const params = {};
    const queryString = window.location.search.slice(1);
    const pairs = queryString.split('&');

    pairs.forEach(pair => {
        const [key, value] = pair.split('=');
        params[key] = decodeURIComponent(value || '');
    });

    console.log("params: ", params);

    if (params["location1"]) {
        document.getElementById('source').value = params.location1;
    }
    if (params.location2) {
        document.getElementById('destination').value = params.location2;
    }
    if (params.pickup_date) {
        document.getElementById('pickup_date').value = params.pickup_date;
    }
    if (params.pickup_time) {
        document.getElementById('pickup_time').value = params.pickup_time;
        $("#save_action").click();
    }
});

// Function to update category details
function updateCategoryDetails(category, costData) {
    var categorySlug = category.toLowerCase();

    console.log("Updating details for category:", category, costData);

    // Update distance (same for both AC and Non AC)
    var distanceElement = document.getElementById("distance_" + categorySlug);
    if (distanceElement) {
        distanceElement.textContent = costData.ac ? costData.ac.distance_km : (costData.non_ac ? costData.non_ac.distance_km : "-");
    }

    // Update AC and Non AC prices and button status
    updatePriceAndButton(categorySlug, "ac", costData.ac);
    updatePriceAndButton(categorySlug, "non_ac", costData.non_ac);
}

// Function to update price details and book button for AC/Non-AC
function updatePriceAndButton(categorySlug, carType, costDetails) {
    var priceElement = document.getElementById("price_" + carType + "_" + categorySlug);
    var permitElement = document.getElementById("permit_" + carType + "_" + categorySlug);
    var tollElement = document.getElementById("toll_" + carType + "_" + categorySlug);
    var betaElement = document.getElementById("beta_" + carType + "_" + categorySlug);
    var bookButton = document.querySelector(`button[data-category="${categorySlug}"][data-type="${carType}"]`);
    var hiddenPriceInput = document.getElementById(`hidden_price_${carType}_${categorySlug}`);

    if (!priceElement || !permitElement || !tollElement || !betaElement || !bookButton || !hiddenPriceInput) {
        console.warn("Some elements are missing for category:", categorySlug, carType);
        return;
    }

    console.log("Updating price and button for:", carType, costDetails);

    if (costDetails && costDetails.cost) {
        // Update price details
        priceElement.textContent = costDetails.cost;
        permitElement.textContent = costDetails.permit || "-";
        tollElement.textContent = costDetails.toll || "-";
        betaElement.textContent = costDetails.beta || "-";

        hiddenPriceInput.value = costDetails.cost;

        // Enable book button if price is available
        bookButton.textContent = `Book ${carType === 'ac' ? 'A/c' : 'Non A/c'}`;
        bookButton.disabled = false;
    } else {
        // If price details are not available
        priceElement.textContent = "Not Available";
        permitElement.textContent = "-";
        tollElement.textContent = "-";
        betaElement.textContent = "-";

        // Disable book button and change text
        bookButton.textContent = `${carType === 'ac' ? 'A/c' : 'Non A/c'} Not Available`;
        bookButton.disabled = true;
    }
}

function getTimeSlot(pickupTime) {
    var time = pickupTime.split(":");
    var hour = parseInt(time[0]);
    
    if (hour >= 0 && hour < 6) {
        return '12AM - 6AM';
    } else if (hour >= 6 && hour < 12) {
        return '6AM - 12PM';
    } else if (hour >= 12 && hour < 18) {
        return '12PM - 6PM';
    } else if (hour >= 18 && hour < 24) {
        return '6PM - 12AM';
    } else {
        return null;  // Invalid time
    }
}

// AJAX request to get pricing details
$("#save_action").click(function(event) {
    event.preventDefault();
    var ridetype = "local";
    var source = $('#source').val();
    var destination = $('#destination').val();
    var pickup_date = $('#pickup_date').val();
    var pickup_time = $('#pickup_time').val();

    
    if (!source || !destination || !pickup_date) {
        alert("All fields are required.");
    } else {
        var time_slot = getTimeSlot(pickup_time);

        if (!time_slot) {
            alert("Invalid pickup time.");
            return;
        }

        $.ajax({
            url: '{% url "get_ride_pricing_details" %}',
            type: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                ridetype: ridetype,
                source: source,
                destination: destination,
                pickup_date: pickup_date,
                pickup_time: pickup_time,
                time_slot: time_slot  
            },
            success: function(result) {
                console.log("Received data: ", result); 
                costs = result.costs;  // Store the costs data

                // Loop through costs and update each category
                for (var category in costs) {
                    if (costs.hasOwnProperty(category)) {
                        updateCategoryDetails(category, costs[category]);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error("Error in AJAX request:", error);
            }
        });
    }
});


</script>

<style>
    .button-equal {
        display: block;
        height: 100%; 
        min-height: 50px; 
        max-height: 50px; 
        color: white;
    }
</style>


{% endblock body_content %}