{% extends "./index.html" %}
{% load static %}

{% block title %}
<title>Package Booking List - Discover Affordable Packages | RidexpressTaxi Services</title>
{% endblock %}

{% block meta_description %}
<meta name="description" 
    content="Explore affordable package booking options with RidexpressTaxi Services. Choose from various packages for local, outstation, and airport travel. Book your preferred package today for a seamless and budget-friendly ride experience." />
{% endblock %}
{% block meta_keywords %}
<meta name="keywords" 
    content="package booking, affordable taxi packages, taxi package deals, local package booking, outstation package booking, airport package booking, cab packages, taxi service packages, budget-friendly packages, cab deals" />
<meta name="keyphrase" 
    content="Outstation packages in Bangalore, local taxi packages, affordable taxi packages in Bangalore, best taxi packages, taxi packages for outstation, airport cab packages, cheap cab packages, package booking service, package cab rental in Bangalore">
<link rel="canonical" href="https://ridexpress.in/package_booking_list" />
{% endblock %}

{% block body_content %}
<br>
<!-- Booking Start -->
<div class="container-fluid booking pb-5 wow fadeIn" data-wow-delay="0.1s">
    <div class="container">
        <div class="bg-white shadow" style="padding: 35px;">
            <div class="row g-2">
                <div class="col-md-12">
                    <div class="row g-2">
                        <!-- <h3>Summary</h3> -->
                        <h6 class="  text-primary text-uppercase">Summary</h6>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="date" id="date1" data-target-input="nearest">
                                    <label>Package Category:</label>
                                    <h6> {{ package_category }}</h6>
                                    <input type="hidden" id="package_category_hidden" name="package_category"
                                        value="{{ package_category }}">
                                    <!-- <input type="text" class="form-control datetimepicker-input" placeholder="Pickup Location" value="{{ source }}" readonly> -->
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="date" id="date2" data-target-input="nearest">
                                    <label>Package:</label>
                                    <h6>{{ package_name }}</h6>
                                    <input type="hidden" id="package_hidden" name="package" value="{{ package_name }}">
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="date" id="date2" data-target-input="nearest">
                                    <label>Price:</label>
                                    <h6>{{ price }}</h6>
                                    <input type="hidden" id="price_hidden" name="price" value="{{ price }}">
                                </div>
                            </div>
                        

                        
                            <div class="col-md-3">
                                <div class="date" id="date1" data-target-input="nearest">
                                    <label>Description:</label>
                                    <h6> {{ description }}</h6>
                                    <input type="hidden" id="description_hidden" name="description"
                                        value="{{ description }}">
                                    <!-- <input type="text" class="form-control datetimepicker-input" placeholder="Pickup Location" value="{{ source }}" readonly> -->
                                </div>
                            </div>
                        </div><br><br><br>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="date" id="date1" data-target-input="nearest">
                                    <label>Pickup Location</label>
                                    <h6>{{ source }}</h6>
                                    <input type="hidden" id="source_hidden" name="source" value="{{ source }}">
                                    <!-- <input type="text" class="form-control datetimepicker-input" placeholder="Pickup Location" value="{{ source }}" readonly> -->
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="date" id="date2" data-target-input="nearest">
                                    <label>Drop Location</label>
                                    <h6>{{ destination }}</h6>
                                    <input type="hidden" id="destination_hidden" name="destination"
                                        value="{{ destination }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="date" id="date2" data-target-input="nearest">
                                    <label>Pickup Date</label>
                                    <h6>{{ pickup_date }}</h6>
                                    <input type="hidden" id="pickup_date_hidden" name="pickup_date"
                                        value="{{ pickup_date }}">
                                    <!-- <input type="date" class="form-control datetimepicker-input"  value="{{ pickup_date }}" readonly> -->
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="date" id="date2" data-target-input="nearest">
                                    <label>Pickup Time</label>
                                    <h6>{{ pickup_time }}</h6>
                                    <input type="hidden" id="pickup_time_hidden" name="pickup_time"
                                        value="{{ pickup_time }}">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>
</div>
<!-- Booking End -->


<!-- Booking Start -->
<div class="container-xxl py-5">
    <div class="container">
        <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
            <h1 class="mb-5"> <span class="text text-uppercase" style="color: rgb(10, 10, 63);">TRAVELLER DETAILS</span>
            </h1>
        </div>
        <div class="row g-5">

            <div class="col-lg-12">
                <div class="wow fadeInUp" data-wow-delay="0.2s">
                    <form>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating date" id="date3" data-target-input="nearest">
                                    <input type="text" class="form-control" id="phone_number"
                                        placeholder="Enter Phone Number">
                                    <label for="phone_number">Phone number</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="customer_name" placeholder="Your Name">
                                    <label for="name">Your Name</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="email" placeholder="Your Email">
                                    <label for="email">Your Email</label>
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="form-floating">
                                    <textarea class="form-control" placeholder="Special Request" id="address"
                                        rows="2"></textarea>
                                    <label for="message">Address</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="password"
                                        placeholder="Create a password">
                                    <label for="password">Password</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label>Payment Method:</label>
                                <div class="d-flex align-items-center">
                                    <!-- <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="payment_method" id="payment_upi" value="UPI">
                                        <label class="form-check-label" for="payment_upi">UPI</label>
                                    </div> -->
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="payment_method" id="payment_cash" value="Cash" checked>
                                        <label class="form-check-label" for="payment_cash" >Cash</label>
                                    </div>
                                    <!-- <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="payment_card" value="Card">
                                        <label class="form-check-label" for="payment_card">Card</label>
                                    </div> -->
                                </div>
                            </div>
                        
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="hidden" class="form-control" id="total_amount" placeholder="Total Amount">
                                    <!-- <label for="total_amount">Total Amount</label> -->
                                </div>
                            </div>
                        
                            
                            <input type="hidden" id="customer_id" name="customer_id">
                            <input type="hidden" id="status" name="status">

                            <center>
                                <div class="col-3">
                                    <button class="btn btn-primary w-100 py-3" type="submit" id="confirmBookingBtn"
                                        style="background-color: #DB9710;border: none;">Book Now</button>
                                </div>
                            </center>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Booking End -->

<!-- Add OTP Modal -->
<center>
    <div id="otpModal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter OTP</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeOtpModal"
                        style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>An OTP has been sent to your WhatsApp number. Please enter it below to confirm your booking.</p>
                    <input type="text" id="otpInput" class="form-control" placeholder="Enter OTP" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="verifyOtpBtn">Verify OTP</button>
                </div>
            </div>
        </div>
    </div>
</center>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>

    // Customer details autofill when phone number changes
    $(document).ready(function () {
        $('#phone_number').on('change', function () {
            var phoneNumber = $(this).val();

            $.ajax({
                url: "{% url 'get_customer_details' %}",
                data: {
                    'phone_number': phoneNumber
                },
                success: function (data) {
                    $('#customer_id').val(data.customer_id);
                    $('#customer_name').val(data.customer_name).prop('readonly', true);
                    $('#email').val(data.email).prop('readonly', true);
                    $('#address').val(data.address).prop('readonly', true);
                    $('#password').val(data.password).prop('readonly', true);
                    $('#customer_notes').val(''); // Clear any existing notes
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 404) {
                        $('#customer_id').val('');
                        $('#customer_name').val('').prop('readonly', false);
                        $('#email').val('').prop('readonly', false);
                        $('#address').val('').prop('readonly', false);
                        $('#password').val('').prop('readonly', false);
                        $('#customer_notes').val(''); 
                    }
                }
            });
        });
    });

    $('#confirmBookingBtn').click(function (event) {
        event.preventDefault();

        var payment_method = $('input[name="payment_method"]:checked').val();

        // Existing booking details object
        var bookingDetails = {
            package_category: $('#package_category_hidden').val(),
            package: $('#package_hidden').val(),
            price: $('#price_hidden').val(),
            description: $('#description_hidden').val(),
            source: $('#source_hidden').val(),
            destination: $('#destination_hidden').val(),
            pickup_date: $('#pickup_date_hidden').val(),
            pickup_time: $('#pickup_time_hidden').val(),
            total_amount: $('#total_amount').val(),
            status:'active',
            customer: $('#customer_id').val(),
            customer_name: $('#customer_name').val(),
            address: $('#address').val(),
            email: $('#email').val(),
            password: $('#password').val(),
            phone_number: $('#phone_number').val(),
            payment_method: payment_method 
        };

        $.ajax({
            url: '{% url "send_otp" %}', 
            type: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                phone_number: bookingDetails.phone_number,
                customer_name: bookingDetails.customer_name
            },
            success: function (result) {
                if (result["status"] == "Success") {
                    $('#otpModal').modal('show');
                } else {
                    alert("Failed to send OTP. Please try again. " + result['message']);
                }
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });

        $('#otpModal').modal({
            backdrop: 'static',
            keyboard: false
        });

       $('#verifyOtpBtn').click(function () {
            var otp = $('#otpInput').val();
            $.ajax({
                url: '{% url "verify_otp" %}',
                type: "POST",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {
                    phone_number: bookingDetails.phone_number,
                    otp: otp
                },
                success: function (result) {
                    if (result["status"] == "Success") {
                        confirmBooking(bookingDetails);
                    } else {
                        alert("Incorrect OTP. Please try again.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        });
    });

    function confirmBooking(bookingDetails) {
    try {
        function formatDateToLocal(dateStr) {
            var date = new Date(dateStr);
            var year = date.getFullYear();
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        if (bookingDetails.pickup_date) {
            var formattedPickupDate = formatDateToLocal(bookingDetails.pickup_date);
            bookingDetails.pickup_date = formattedPickupDate;
        } else {
            throw new Error("Pickup date is missing.");
        }

        

        $.ajax({
            url: '{% url "add_package_booking" %}',
            type: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: bookingDetails,
            success: function (result) {
                if (result["status"] !== "Error") {
                    var customerName = bookingDetails.customer_name || 'Customer';
                    var orderId = result.order_id || 'N/A'; // Adjust based on the response format
                    
                    var message = `Hello ${customerName},\n\nThank you for choosing Ridexpress!\n\nWe’re happy to confirm your booking:\n\nOrder Id: ${orderId}\nPickup Date & Time: ${bookingDetails.pickup_date} ${bookingDetails.pickup_time}\nPickup Location: ${bookingDetails.source}\nDrop-off Location: ${bookingDetails.destination}\n\nCab details will be provided shortly. If you have any changes or need further assistance, feel free to reach out to us at +91 6366463555 or reply to this message.\n\nWe look forward to serving you!\n\nBest regards,\nRidexpress\nsupport@ridexpress.in\nridexpress.in`;

                    alert("Thank you for booking with us. Information will be shared with you over WhatsApp.");
                    window.location.href = "{% url 'home' %}"; 
                } else {
                    alert("Oops, something went wrong. Please try again. " + result['message']);
                }
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    } catch (e) {
        alert("Error: " + e.message);
        console.error(e);
    }
}

    $(document).ready(function () {
        $('#closeOtpModal').click(function () {
            $('#otpModal').modal('hide'); 
        });
    });
</script>

<style>
    /* Required Bootstrap Modal CSS */
    .modal {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1050;
        display: none;
        overflow: hidden;
        outline: 0;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        margin: 0.5rem;
        pointer-events: none;
    }

    .modal.fade .modal-dialog {
        transition: -webkit-transform 0.3s ease-out;
        transition: transform 0.3s ease-out;
        transition: transform 0.3s ease-out, -webkit-transform 0.3s ease-out;
        -webkit-transform: translate(0, -50px);
        transform: translate(0, -50px);
    }

    .modal.show .modal-dialog {
        -webkit-transform: translate(0, 0);
        transform: translate(0, 0);
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        outline: 0;
    }

    .modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 1rem 1rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: 0.3rem;
        border-top-right-radius: 0.3rem;
    }

    .modal-footer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        border-bottom-right-radius: 0.3rem;
        border-bottom-left-radius: 0.3rem;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal-header .close {
        font-size: 1.5rem;
        font-weight: bold;
        color: #000;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        margin: -1rem -4rem -1rem auto;
        /* Adjust position */
    }

    .modal-header .close:hover,
    .modal-header .close:focus {
        color: #000;
        text-decoration: none;
    }
</style>
{% endblock body_content %}